{% extends "base.html" %}

{% block title %}Ficha DML #{{ ficha.numero_ficha }}{% endblock %}

{% block content %}
<style>
    .ficha-container {
        max-width: 1100px;
        margin: 20px auto;
        background: white;
        padding: 30px;
        border: 2px solid #000;
        font-family: Arial, sans-serif;
    }
    .header-row {
        display: grid;
        grid-template-columns: 150px 1fr 400px;
        gap: 20px;
        margin-bottom: 20px;
        align-items: center;
    }
    .ficha-numero {
        font-size: 24px;
        font-weight: bold;
    }
    .servicio-tecnico {
        text-align: center;
        font-size: 18px;
        font-weight: bold;
    }
    .titulo-principal {
        text-align: center;
        font-size: 16px;
        font-weight: bold;
        border: 2px solid #000;
        padding: 10px;
        text-decoration: underline;
    }
    .logo-container {
        text-align: center;
    }
    .logo-container img {
        max-width: 120px;
        height: auto;
    }
    .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    .info-row {
        display: grid;
        grid-template-columns: 250px 1fr;
        margin-bottom: 8px;
        font-size: 12px;
    }
    .info-label {
        font-weight: bold;
    }
    .info-value {
        border-bottom: 1px solid #000;
        padding-left: 10px;
    }
    .estado-equipo-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
    }
    .estado-equipo-table td {
        border: 1px solid #000;
        padding: 4px 8px;
    }
    .estado-equipo-table .header-cell {
        background-color: #d9d9d9;
        font-weight: bold;
        text-align: center;
    }
    .section-title {
        background-color: #d9d9d9;
        border: 1px solid #000;
        padding: 8px;
        font-weight: bold;
        text-align: center;
        margin-top: 15px;
        margin-bottom: 10px;
        font-size: 13px;
    }
    .large-text-box {
        min-height: 100px;
        padding: 10px;
        border: 1px solid #000;
        background-color: #fff;
        margin-bottom: 15px;
        white-space: pre-wrap;
        font-size: 12px;
    }
    .repuestos-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
        font-size: 11px;
    }
    .repuestos-table th {
        background-color: #d9d9d9;
        border: 1px solid #000;
        padding: 6px;
        font-weight: bold;
    }
    .repuestos-table td {
        border: 1px solid #000;
        padding: 6px;
        text-align: center;
    }
    .ciclos-section {
        margin-top: 20px;
    }
    .ciclos-row {
        display: grid;
        grid-template-columns: 400px 1fr;
        margin-bottom: 8px;
        font-size: 12px;
    }
    .footer-text {
        text-align: center;
        font-weight: bold;
        margin-top: 20px;
        font-size: 12px;
    }
    .btn-group {
        margin-top: 30px;
        text-align: center;
        border-top: 2px solid #ccc;
        padding-top: 20px;
    }
</style>

<div class="ficha-container">
    <!-- ENCABEZADO -->
    <div class="header-row">
        <div>
            <div style="font-size: 14px; font-weight: bold;">N¬∫ Ficha</div>
            <div class="ficha-numero">{{ '%07d' % ficha.numero_ficha }}</div>
        </div>
        <div class="logo-container">
            <img src="{{ url_for('static', filename='raypac_logo.png') }}" alt="RAYPAC" onerror="this.style.display='none'">
        </div>
        <div class="titulo-principal">
            INFORME DML SOBRE EL<br>EQUIPO EN REVISION
        </div>
    </div>
    
    <div class="servicio-tecnico">Servicio T√©cnico</div>

    <!-- CONTENIDO PRINCIPAL: INFO IZQUIERDA + ESTADO EQUIPO DERECHA -->
    <div class="main-grid">
        <!-- COLUMNA IZQUIERDA: INFORMACI√ìN -->
        <div>
            <div class="info-row">
                <div class="info-label">Fecha de recepci√≥n Raypac:</div>
                <div class="info-value">{{ raypac.fecha_recepcion if raypac else '' }}</div>
            </div>
            
            <div class="info-row">
                <div class="info-label">Comercial responsable:</div>
                <div class="info-value">{{ raypac.comercial if raypac else '' }}</div>
            </div>
            
            <div class="info-row">
                <div class="info-label">Nombre del Cliente:</div>
                <div class="info-value">{{ raypac.cliente if raypac else '' }}</div>
            </div>
            
            <div class="info-row">
                <div class="info-label">Equipo Recibido:</div>
                <div class="info-value">
                    {{ raypac.modelo_maquina if raypac else '' }}
                    <span style="margin-left: 40px;"><strong>Serie N¬∞:</strong> {{ raypac.numero_serie if raypac else '' }}</span>
                </div>
            </div>
            
            <div class="info-row">
                <div class="info-label">Fecha de ingreso DML:</div>
                <div class="info-value">
                    {{ ficha.fecha_ingreso }}
                    <span style="margin-left: 40px;"><strong>Bat N¬∞:</strong> {{ raypac.numero_bateria if raypac else 'NO APLICA' }}</span>
                </div>
            </div>
            
            <div class="info-row">
                <div class="info-label">Fecha de egreso DML:</div>
                <div class="info-value">
                    {{ ficha.fecha_egreso or '' }}
                    <span style="margin-left: 40px;"><strong>Cargador N¬∞:</strong> {{ raypac.numero_cargador if raypac else 'NO APLICA' }}</span>
                </div>
            </div>
            
            <div class="info-row">
                <div class="info-label">Remito de Salida (DML‚ÜíRAYPAC):</div>
                <div class="info-value">
                    {% if ficha.numero_remito_salida %}
                        <strong style="color: #28a745;">{{ ficha.numero_remito_salida }}</strong>
                    {% else %}
                        <span style="color: #dc3545;">‚ö†Ô∏è PENDIENTE (requerido para cerrar)</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- COLUMNA DERECHA: ESTADO DEL EQUIPO -->
        <div>
            <table class="estado-equipo-table">
                <tr>
                    <td colspan="2" class="header-cell">ESTADO DEL EQUIPO</td>
                </tr>
                {% for parte in partes %}
                <tr>
                    <td style="font-weight: bold;">{{ parte.nombre_parte }}</td>
                    <td>{{ parte.estado or 'BUENO' }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    <!-- DIAGN√ìSTICO DEL DEPARTAMENTO T√âCNICO -->
    <div class="section-title">DIAGNOSTICO DEL DEPARTAMENTO TECNICO</div>
    <div class="large-text-box">{{ ficha.diagnostico_inicial or '' }}</div>

    <!-- OBSERVACIONES -->
    <div class="section-title">OBSERVACIONES</div>
    <div class="large-text-box">{{ ficha.observaciones or '' }}</div>

    <!-- DIAGN√ìSTICO DE REPARACI√ìN -->
    <div class="section-title">DIAGNOSTICO DE REPARACI√ìN</div>
    <div class="large-text-box">{{ ficha.diagnostico_reparacion or '' }}</div>

    <!-- REPUESTOS COLOCADOS -->
    <div class="section-title">REPUESTOS COLOCADOS</div>
    <table class="repuestos-table">
        <thead>
            <tr>
                <th>Cantidad</th>
                <th>Codigo</th>
                <th>DESCRIPCION</th>
                <th>ESTADO</th>
                <th>EN STOCK</th>
                <th>EN FALTA</th>
            </tr>
        </thead>
        <tbody>
            {% for repuesto in repuestos %}
            <tr>
                <td>{{ repuesto.cantidad_utilizada or repuesto.cantidad }}</td>
                <td>{{ repuesto.codigo_repuesto }}</td>
                <td style="text-align: left;">{{ repuesto.descripcion }}</td>
                <td>{{ get_alert_badge(repuesto.codigo_repuesto, 'DML') | safe }}</td>
                <td>{% if repuesto.en_stock %}<span style="color: green; font-size: 16px;">‚úì</span>{% endif %}</td>
                <td>{% if repuesto.en_falta %}<span style="color: red; font-size: 16px;">‚úó</span>{% endif %}</td>
            </tr>
            {% endfor %}
            <!-- Rellenar hasta 8 filas -->
            {% for i in range(repuestos|length, 8) %}
            <tr>
                <td>0</td>
                <td>0</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- SECCI√ìN DE CICLOS Y DATOS FINALES -->
    <div class="ciclos-section">
        <div class="ciclos-row">
            <div style="font-weight: bold;">N¬∞ DE CICLOS DE LA M√ÅQUINA CON LAS QUE SALE DE ST</div>
            <div style="border-bottom: 1px solid #000; text-align: center;">{{ ficha.n_ciclos or 0 }}</div>
        </div>

        <div class="section-title" style="margin-top: 20px;">MARCAR CON UNA CRUZ LO QUE CORRESPONDA</div>

        <div class="ciclos-row">
            <div>TIPO DE MAQUINA QUE INGRESO AL ST</div>
            <div style="border-bottom: 1px solid #000; text-align: center;">{{ raypac.tipo_maquina if raypac else 'A BATERIA' }}</div>
        </div>

        <div class="ciclos-row">
            <div>El m√≥dulo reparaci√≥n Base es de tres (3hs)</div>
            <div></div>
        </div>

        <div class="ciclos-row">
            <div>HORAS ADICIONALES DE TRABAJO</div>
            <div style="border-bottom: 1px solid #000; text-align: center;">{{ ficha.horas_adic or 'NO APLICA' }}</div>
        </div>

        <div class="ciclos-row">
            <div>MECANIZADO ADICIONAL REALIZADO A LA MAQUINA</div>
            <div style="border-bottom: 1px solid #000; text-align: center;">{{ ficha.mecanizado_adic or 'NO APLICA' }}</div>
        </div>

        <div class="ciclos-row">
            <div>TIPO DE TRABAJO REALIZADO</div>
            <div style="border-bottom: 1px solid #000; text-align: center;">REPARACI√ìN</div>
        </div>

        <div class="ciclos-row">
            <div>T√âCNICO RESPONSABLE DEL ST DE DML</div>
            <div style="border-bottom: 1px solid #000; text-align: center;">{{ ficha.tecnico_resp or '' }}</div>
        </div>
    </div>

    <div class="footer-text">SERVICIO T√âCNICO- DML ELECTRICIDAD INDUSTRIAL SRL</div>

    <!-- BOTONES DE ACCI√ìN -->
    <div class="btn-group">
        <a href="{{ url_for('dml_edit', id=ficha.id) }}" class="btn btn-primary btn-lg" style="margin-right: 10px;">
            ‚úèÔ∏è Editar Ficha
        </a>
        
        {% if not ficha.numero_ticket %}
        <form method="POST" action="{{ url_for('crear_ticket_endpoint', id=ficha.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-warning btn-lg" style="margin-right: 10px;">
                üé´ Crear Ticket
            </button>
        </form>
        {% else %}
        <a href="{{ url_for('ticket_view', numero_ticket=ficha.numero_ticket) }}" class="btn btn-info btn-lg" style="margin-right: 10px;" target="_blank">
            üîç Ver Ticket: {{ ficha.numero_ticket }}
        </a>
        {% endif %}
        
        <a href="{{ url_for('descargar_ficha_pdf', id=ficha.id) }}" class="btn btn-success btn-lg" style="margin-right: 10px;" target="_blank">
            üìÑ Descargar PDF
        </a>
        
        {% if not ficha.is_closed %}
        <form method="POST" action="{{ url_for('dml_close', id=ficha.id) }}" style="display: inline;" onsubmit="return confirm('¬øDeseas FINALIZAR esta ficha? Se enviar√° notificaci√≥n al comercial.');">
            <button type="submit" class="btn btn-danger btn-lg" style="margin-right: 10px;">
                üîí Cerrar Ficha
            </button>
        </form>
        {% else %}
        <span class="badge badge-success" style="display: inline-block; padding: 10px 15px; background-color: #28a745; color: white; border-radius: 5px; font-weight: bold; margin-right: 10px;">
            ‚úÖ FICHA FINALIZADA
        </span>
        {% endif %}
        
        <a href="{{ url_for('dml_list') }}" class="btn btn-secondary btn-lg">
            ‚¨ÖÔ∏è Volver al Listado
        </a>
    </div>
</div>

{% endblock %}

{% extends "base.html" %}

{% block title %}Ficha DML #{{ ficha.numero_ficha }}{% endblock %}

{% block content %}
<style>
    .section-header {
        background-color: #C0C0C0;
        font-weight: bold;
        padding: 8px 12px;
        margin-top: 15px;
        margin-bottom: 10px;
        border: 1px solid #999;
    }
    .ficha-header {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .ficha-label {
        font-weight: bold;
        font-size: 13px;
    }
    .ficha-value {
        font-size: 12px;
    }
    .ficha-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
    }
    .ficha-table td {
        padding: 6px;
        border: 1px solid #ccc;
        font-size: 12px;
    }
    .ficha-table th {
        background-color: #003366;
        color: white;
        padding: 6px;
        font-weight: bold;
        font-size: 11px;
        border: 1px solid #ccc;
    }
    .ficha-container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border: 1px solid #ddd;
    }
    .form-agregar-repuesto {
        background-color: #e7f3ff;
        padding: 12px;
        border: 1px solid #b3d9ff;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    .checklist-table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
    }
    .checklist-table td {
        padding: 4px 6px;
        border: 1px solid #ccc;
        font-size: 11px;
    }
    .checklist-col-left {
        width: 45%;
    }
    .checklist-col-right {
        width: 45%;
    }
    .large-box {
        min-height: 120px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #f9f9f9;
        margin-bottom: 15px;
    }
</style>

<div class="ficha-container">
    <!-- ENCABEZADO -->
    <div class="ficha-header">INFORME DML SOBRE EL EQUIPO EN REVISION</div>
    <div style="margin-bottom: 10px;">
        <div class="ficha-label">Nº Ficha: {{ ficha.numero_ficha }}</div>
        <div style="font-size: 12px; margin-top: 3px;">500 - Servicio Técnico</div>
    </div>

    <!-- SECCIÓN 1: DATOS GENERALES -->
    <div class="section-header">DATOS GENERALES</div>
    <table class="ficha-table">
        <tr>
            <td class="ficha-label">Fecha de recepción Raypac:</td>
            <td class="ficha-value">{{ ficha.fecha_ingreso }}</td>
            <td colspan="2"></td>
            <td class="ficha-label">ESTADO DEL EQUIPO</td>
            <td class="ficha-value"><strong>BUENO</strong></td>
        </tr>
        <tr>
            <td class="ficha-label">Comercial responsable:</td>
            <td class="ficha-value" colspan="2">{{ ficha.comercial or '' }}</td>
            <td></td>
            <td class="ficha-label">CARCAZA</td>
            <td class="ficha-value">
                {% for parte in partes %}
                    {% if parte.nombre_parte == 'CARCAZA' %}
                        {{ parte.estado }}
                    {% endif %}
                {% endfor %}
            </td>
        </tr>
        <tr>
            <td class="ficha-label">Nombre del Cliente:</td>
            <td class="ficha-value" colspan="3">{{ ficha.cliente or '' }}</td>
            <td class="ficha-label">CUBRE FEEDWHEEL</td>
            <td class="ficha-value">
                {% for parte in partes %}
                    {% if parte.nombre_parte == 'CUBRE FEEDWHEEL' %}
                        {{ parte.estado }}
                    {% endif %}
                {% endfor %}
            </td>
        </tr>
        <tr>
            <td class="ficha-label">Equipo Recibido:</td>
            <td class="ficha-value">{{ ficha.modelo_maquina or '' }}</td>
            <td class="ficha-label">Serie N°:</td>
            <td class="ficha-value">{{ ficha.numero_serie or '' }}</td>
            <td class="ficha-label">MANGO</td>
            <td class="ficha-value">
                {% for parte in partes %}
                    {% if parte.nombre_parte == 'MANGO' %}
                        {{ parte.estado }}
                    {% endif %}
                {% endfor %}
            </td>
        </tr>
        <tr>
            <td class="ficha-label">Fecha de ingreso DML:</td>
            <td class="ficha-value">{{ ficha.fecha_ingreso }}</td>
            <td class="ficha-label">Bat N°:</td>
            <td class="ficha-value">{{ ficha.numero_bateria or 'NO APLICA' }}</td>
            <td class="ficha-label">BOTONES</td>
            <td class="ficha-value">
                {% for parte in partes %}
                    {% if parte.nombre_parte == 'BOTONES' %}
                        {{ parte.estado }}
                    {% endif %}
                {% endfor %}
            </td>
        </tr>
        <tr>
            <td class="ficha-label">Fecha de egreso DML:</td>
            <td class="ficha-value">{{ ficha.fecha_egreso or '' }}</td>
            <td class="ficha-label">Cargador N°:</td>
            <td class="ficha-value">{{ ficha.numero_cargador or 'NO APLICA' }}</td>
            <td class="ficha-label">MOTOR DE ARRASTRE</td>
            <td class="ficha-value">
                {% for parte in partes %}
                    {% if parte.nombre_parte == 'MOTOR DE ARRASTRE' %}
                        {{ parte.estado }}
                    {% endif %}
                {% endfor %}
            </td>
        </tr>
    </table>

    <!-- SECCIÓN 2: DIAGNÓSTICO -->
    <div class="section-header">DIAGNOSTICO DEL DEPARTAMENTO TECNICO</div>
    <div class="large-box">
        {{ ficha.diagnostico_inicial or 'Sin diagnóstico' }}
    </div>

    <!-- SECCIÓN 3: DIAGNÓSTICO DE REPARACIÓN -->
    <div class="section-header">DIAGNOSTICO DE REPARACION</div>
    <div class="large-box">
        {{ ficha.diagnostico_reparacion or '' }}
    </div>

    <!-- SECCIÓN 5: CONCLUSIÓN -->
    <div class="section-header">OBSERVACIONES</div>
    <div class="large-box">
        {{ ficha.observaciones or '' }}
    </div>

    <!-- SECCIÓN 6: DETALLE DE REPARACIÓN -->
    <div class="section-header">REPUESTOS COLOCADOS</div>
    <table class="ficha-table">
        <thead>
            <tr>
                <th>Cantidad</th>
                <th>Codigo</th>
                <th>DESCRIPCION</th>
            </tr>
        </thead>
        <tbody>
            {% for repuesto in repuestos %}
            <tr>
                <td>{{ repuesto.cantidad_utilizada if repuesto.cantidad_utilizada else repuesto.cantidad }}</td>
                <td>{{ repuesto.codigo_repuesto }}</td>
                <td>{{ repuesto.descripcion }}</td>
            </tr>
            {% endfor %}
            {% for i in range(8 - repuestos|length) %}
            <tr>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- SECCIÓN 7: CICLOS Y HORAS -->
    <div class="section-header">CICLOS Y MANO DE OBRA</div>
    <table class="ficha-table">
        <tr>
            <td class="ficha-label">Ciclos</td>
            <td class="ficha-value">{{ ficha.n_ciclos or '0' }}</td>
        </tr>
        <tr>
            <td class="ficha-label">Marcar con una cruz lo que corresponda</td>
            <td></td>
        </tr>
        <tr>
            <td class="ficha-label">Mano de obra - Módulo reparación Base (3hs) Máq Batería o Neumática</td>
            <td class="ficha-value">✓</td>
        </tr>
        <tr>
            <td class="ficha-label">Mano de obra - Módulo reparación Base (3hs) Máq Manual</td>
            <td></td>
        </tr>
        <tr>
            <td class="ficha-label">Hora Adicional</td>
            <td class="ficha-value">{{ ficha.horas_adic or 'NO APLICA' }}</td>
        </tr>
        <tr>
            <td class="ficha-label">Costo presupuesto máquina Batería o Neumática</td>
            <td></td>
        </tr>
        <tr>
            <td class="ficha-label">Costo presupuesto máquina Manual</td>
            <td></td>
        </tr>
    </table>

    <!-- SECCIÓN 8: INFORMACIÓN ADICIONAL -->
    <div class="section-header">INFORMACION ADICIONAL</div>
    <table class="ficha-table">
        <tr>
            <td class="ficha-label">Tipo de Máquina:</td>
            <td class="ficha-value">A BATERIA</td>
        </tr>
        <tr>
            <td class="ficha-label">Mecanizado Adicional:</td>
            <td class="ficha-value">{{ ficha.mecanizado_adic or 'NO APLICA' }}</td>
        </tr>
        <tr>
            <td class="ficha-label">Tipo de Trabajo Realizado:</td>
            <td class="ficha-value">REPARACIÓN</td>
        </tr>
        <tr>
            <td class="ficha-label">Técnico Responsable del ST de DML:</td>
            <td class="ficha-value">{{ ficha.tecnico_resp or '' }}</td>
        </tr>
    </table>

    <!-- FOOTER -->
    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ccc; font-weight: bold; font-size: 11px;">
        SERVICIO TÉCNICO- DML ELECTRICIDAD INDUSTRIAL SRL
    </div>

    <!-- FORMULARIO AGREGAR REPUESTO (para edición) -->
    {% if ficha.estado_reparacion != 'MÁQUINA LISTA PARA RETIRAR' %}
    <div class="form-agregar-repuesto" style="margin-top: 20px;">
        <h6 style="color: #003366; font-weight: bold; margin-bottom: 10px;">Agregar Nuevo Repuesto</h6>
        <form id="formAgregarRepuesto" method="POST" action="{{ url_for('agregar_repuesto', id=ficha.id) }}">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                <div>
                    <label style="font-weight: bold; font-size: 12px;">Código Repuesto:</label>
                    <input type="text" name="codigo_repuesto" class="form-control form-control-sm" placeholder="ej. A000006" required>
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 12px;">Descripción:</label>
                    <input type="text" name="descripcion" class="form-control form-control-sm" placeholder="Descripción" required>
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 12px;">Cantidad Utilizada:</label>
                    <input type="number" name="cantidad_utilizada" class="form-control form-control-sm" value="1" min="1" required>
                </div>
                <div>
                    <label style="font-weight: bold; font-size: 12px;">Estado:</label>
                    <select name="estado_repuesto" class="form-control form-control-sm" required>
                        <option value="">Seleccionar...</option>
                        <option value="INSPECCIONADO">INSPECCIONADO</option>
                        <option value="LIMPIO">LIMPIO</option>
                        <option value="PROBADO">PROBADO</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-sm btn-primary" style="margin-top: 10px;" onclick="return confirm('¿Agregar repuesto?')">
                Agregar Repuesto
            </button>
        </form>
    </div>
    {% endif %}

    <!-- ACCIONES -->
    <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
        {% if ficha.estado_reparacion != 'MÁQUINA LISTA PARA RETIRAR' %}
        <a href="{{ url_for('dml_edit', id=ficha.id) }}" class="btn btn-primary btn-sm">Editar Ficha Completa</a>
        {% endif %}
        
        {% if ficha.estado_reparacion == 'MÁQUINA LISTA PARA RETIRAR' and not ficha.ficha_generada %}
        <form method="POST" action="{{ url_for('generar_ficha', id=ficha.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('¿Generar ficha y PDF?')">
                Generar Ficha PDF
            </button>
        </form>
        {% endif %}
        
        {% if ficha.ficha_generada %}
        <a href="{{ url_for('descargar_ficha_pdf', id=ficha.id) }}" class="btn btn-success btn-sm">
            ✓ Descargar Ficha PDF
        </a>
        {% endif %}
        
        <a href="{{ url_for('dml_list') }}" class="btn btn-secondary btn-sm">Volver</a>
    </div>
</div>

{% endblock %}


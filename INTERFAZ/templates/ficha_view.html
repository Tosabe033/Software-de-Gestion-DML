{% extends "base.html" %}
{% block content %}
<h3>Ficha DML #{{ ficha['id'] }}</h3>
<p>
  <strong>Cliente:</strong> {{ ficha['cliente'] }} |
  <strong>Serie:</strong> {{ ficha['numero_serie'] }} |
  <strong>Modelo:</strong> {{ ficha['modelo_maquina'] }}
</p>
<p>
  <strong>Fecha ingreso:</strong> {{ ficha['fecha_ingreso'] }} |
  <strong>Fecha egreso:</strong> {{ ficha['fecha_egreso'] }}
</p>
<p>
  <strong>Estado general:</strong> {{ ficha['estado_general'] }}
</p>
<p>
  <strong>Máquina con varios detalles:</strong> {{ ficha['maquina_detalles'] }}
</p>

<h5>Partes del equipo</h5>
<table class="table table-bordered table-sm">
  <thead>
    <tr><th>Parte</th><th>Estado</th></tr>
  </thead>
  <tbody>
    {% for p in partes %}
    <tr>
      <td>{{ p['parte'] }}</td>
      <td>{{ p['estado'] }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h5>Repuestos colocados</h5>
<table class="table table-bordered table-sm align-middle">
  <thead>
    <tr>
      <th>Cant.</th>
      <th>Código</th>
      <th>Descripción</th>
      <th>En stock</th>
      <th>En falta</th>
    </tr>
  </thead>
  <tbody>
    {% for r in repuestos %}
    <tr>
      <td>{{ r['cantidad'] }}</td>
      <td>{{ r['codigo'] }}</td>
      <td>{{ r['descripcion'] }}</td>
      <td class="text-center">{% if r['en_stock'] %}✅{% else %}-{% endif %}</td>
      <td class="text-center">{% if r['en_falta'] %}❌{% else %}-{% endif %}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h5>Datos finales</h5>
<ul>
  <li><strong>N° de ciclos:</strong> {{ ficha['n_ciclos'] }}</li>
  <li><strong>Tipo de máquina que ingresó al ST:</strong> {{ ficha['tipo_maquina_st'] }}</li>
  <li><strong>Horas adicionales:</strong> {{ ficha['horas_adic'] }}</li>
  <li><strong>Mecanizado adicional:</strong> {{ ficha['mecanizado_adic'] }}</li>
  <li><strong>Tipo de trabajo:</strong> {{ ficha['tipo_trabajo'] }}</li>
  <li><strong>Técnico responsable ST DML:</strong> {{ ficha['tecnico_resp'] }}</li>
  <li><strong>Bat N°:</strong> {{ ficha['bat_num'] }}</li>
  <li><strong>Cargador N°:</strong> {{ ficha['cargador_num'] }}</li>
  <li><strong>N° remito carga:</strong> {{ ficha['remito_carga'] }}</li>
</ul>

<form method="post" class="mt-3">
  <div class="row">
    <div class="col-md-4 mb-3">
      <label class="form-label">Cambiar estado</label>
      <select class="form-select" name="estado_general">
        {% for e in estados %}
        <option value="{{ e }}" {% if e==ficha['estado_general'] %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 mb-3 d-flex align-items-end">
      <button name="action" value="cambiar_estado" class="btn btn-primary w-100">Guardar estado</button>
    </div>
    {% if user['role']=='ADMIN' %}
    <div class="col-md-3 mb-3 offset-md-1">
      <label class="form-label">Código de desbloqueo (para editar ficha cerrada)</label>
      <input type="text" class="form-control" name="unfreeze_code">
    </div>
    <div class="col-md-2 mb-3 d-flex align-items-end">
      <button name="action" value="desbloquear" class="btn btn-warning w-100">Desbloquear</button>
    </div>
    {% endif %}
  </div>
</form>
{% endblock %}

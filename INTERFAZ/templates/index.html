{% extends "base.html" %}

{% block title %}Dashboard - DML ST{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Inicio</h1>

    {% set role = user.role %}

    {% if role == 'RAYPAC' %}
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i> <strong>Dashboard RAYPAC:</strong> Gestión de ingresos desde casa matriz y envíos de repuestos a DML.
    </div>
    
    <h4 class="mb-3"><i class="bi bi-box-seam"></i> Control de Ingresos</h4>
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <a href="{{ url_for('raypac_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #007bff; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-box-seam" style="font-size: 2.5rem; color: #007bff;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Equipos Registrados</h5>
                        <h1 class="display-4 fw-bold text-primary">{{ stats.equipos_registrados }}</h1>
                        <p class="text-muted small mb-0">Total de equipos ingresados en el sistema</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('raypac_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.equipos_sin_remito > 0 %}border-warning{% endif %}" style="border-left: 5px solid #ffc107; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-truck" style="font-size: 2.5rem; color: #ffc107;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Sin Remito</h5>
                        <h1 class="display-4 fw-bold text-warning">{{ stats.equipos_sin_remito }}</h1>
                        <p class="text-muted small mb-0">Equipos pendientes de documentación</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('envios_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.envios_pendientes > 0 %}border-warning{% endif %}" style="border-left: 5px solid #ffc107; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-send-check" style="font-size: 2.5rem; color: #ffc107;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Envíos Realizados</h5>
                        <h1 class="display-4 fw-bold text-warning">{{ stats.envios_pendientes }}</h1>
                        <p class="text-muted small mb-0">Envíos de repuestos a DML</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('tickets_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.tickets_activos > 0 %}border-info{% endif %}" style="border-left: 5px solid #17a2b8; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-ticket-perforated" style="font-size: 2.5rem; color: #17a2b8;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Tickets Activos</h5>
                        <h1 class="display-4 fw-bold text-info">{{ stats.tickets_activos or 0 }}</h1>
                        <p class="text-muted small mb-0">Tickets de seguimiento en proceso</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>

    {% elif role == 'DML_REPUESTOS' %}
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i> <strong>Dashboard Repuestos:</strong> Control de inventario DML y gestión de tickets de reparación.
    </div>
    
    <h4 class="mb-3"><i class="bi bi-bag-check-fill"></i> Control de Inventario</h4>
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <a href="{{ url_for('stock_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.stock_bajo > 0 %}border-danger{% endif %}" style="border-left: 5px solid #dc3545; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-exclamation-triangle" style="font-size: 2.5rem; color: #dc3545;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Stock DML ≤2</h5>
                        <h1 class="display-4 fw-bold text-danger">{{ stats.stock_bajo }}</h1>
                        <p class="text-muted small mb-0">Repuestos con inventario crítico</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('envios_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.envios_pendientes > 0 %}border-warning{% endif %}" style="border-left: 5px solid #ffc107; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-truck" style="font-size: 2.5rem; color: #ffc107;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Envíos Pendientes</h5>
                        <h1 class="display-4 fw-bold text-warning">{{ stats.envios_pendientes }}</h1>
                        <p class="text-muted small mb-0">Envíos de RAYPAC por recepcionar</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.fichas_espera_repuestos > 0 %}border-info{% endif %}" style="border-left: 5px solid #17a2b8; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-clock-history" style="font-size: 2.5rem; color: #17a2b8;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Espera Repuestos</h5>
                        <h1 class="display-4 fw-bold text-info">{{ stats.fichas_espera_repuestos }}</h1>
                        <p class="text-muted small mb-0">Fichas bloqueadas por falta de stock</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('tickets_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #007bff; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-ticket-detailed" style="font-size: 2.5rem; color: #007bff;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Tickets Activos</h5>
                        <h1 class="display-4 fw-bold text-primary">{{ stats.tickets_activos }}</h1>
                        <p class="text-muted small mb-0">Tickets en seguimiento</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>

    {% elif role == 'DML_ST' %}
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i> <strong>Dashboard del Técnico:</strong> Vista general del flujo de reparaciones. Haz clic en cada tarjeta para ver el detalle.
    </div>
    
    <h4 class="mb-3"><i class="bi bi-gear-fill"></i> Flujo de Reparación</h4>
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #17a2b8; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-search" style="font-size: 2.5rem; color: #17a2b8;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Revisión Inicial</h5>
                        <h1 class="display-4 fw-bold text-info">{{ stats.fichas_revision_inicial }}</h1>
                        <p class="text-muted small mb-0">Equipos recién llegados pendientes de diagnóstico</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #007bff; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-tools" style="font-size: 2.5rem; color: #007bff;"></i>
                        </div>
                        <h5 class="card-title fw-bold">En Reparación</h5>
                        <h1 class="display-4 fw-bold text-primary">{{ stats.fichas_en_reparacion }}</h1>
                        <p class="text-muted small mb-0">Máquinas en proceso de reparación activa</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #ffc107; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-clock-history" style="font-size: 2.5rem; color: #ffc107;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Esperando Repuestos</h5>
                        <h1 class="display-4 fw-bold text-warning">{{ stats.fichas_espera_repuestos }}</h1>
                        <p class="text-muted small mb-0">Pausadas hasta recibir componentes</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #28a745; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-check-circle-fill" style="font-size: 2.5rem; color: #28a745;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Listas para Retirar</h5>
                        <h1 class="display-4 fw-bold text-success">{{ stats.fichas_listas }}</h1>
                        <p class="text-muted small mb-0">Reparadas y listas para entrega</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>
    
    <h4 class="mb-3 mt-4"><i class="bi bi-bell-fill"></i> Alertas y Pendientes</h4>
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <a href="{{ url_for('raypac_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.equipos_raypac_pendientes > 0 %}border-warning{% endif %}" style="transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-box-seam" style="font-size: 2rem; color: #ff9800;"></i>
                            </div>
                            <h2 class="display-6 fw-bold text-warning mb-0">{{ stats.equipos_raypac_pendientes }}</h2>
                        </div>
                        <h6 class="fw-bold">Equipos RAYPAC Pendientes</h6>
                        <p class="text-muted small mb-0"><i class="bi bi-arrow-right-circle"></i> Envíos de casa matriz para recepcionar y crear fichas</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.repuestos_disponibles > 0 %}border-success{% endif %}" style="transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-bag-check-fill" style="font-size: 2rem; color: #28a745;"></i>
                            </div>
                            <h2 class="display-6 fw-bold text-success mb-0">{{ stats.repuestos_disponibles }}</h2>
                        </div>
                        <h6 class="fw-bold">Repuestos Disponibles</h6>
                        <p class="text-muted small mb-0"><i class="bi bi-arrow-right-circle"></i> Componentes que estaban agotados ahora en stock</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('tickets_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-ticket-perforated-fill" style="font-size: 2rem; color: #6c757d;"></i>
                            </div>
                            <h2 class="display-6 fw-bold text-dark mb-0">{{ stats.tickets_activos }}</h2>
                        </div>
                        <h6 class="fw-bold">Tickets Activos</h6>
                        <p class="text-muted small mb-0"><i class="bi bi-arrow-right-circle"></i> Tickets de seguimiento para clientes</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>

    {% else %} {# ADMIN #}
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i> <strong>Dashboard Administrador:</strong> Vista completa del sistema con acceso a todas las secciones y estadísticas.
    </div>
    
    <h4 class="mb-3"><i class="bi bi-speedometer2"></i> Estado General del Sistema</h4>
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <a href="{{ url_for('raypac_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #007bff; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-box-seam" style="font-size: 2.5rem; color: #007bff;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Equipos RAYPAC</h5>
                        <h1 class="display-4 fw-bold text-primary">{{ stats.equipos_raypac }}</h1>
                        <p class="text-muted small mb-0">Total de ingresos desde casa matriz</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.fichas_abiertas > 0 %}border-warning{% endif %}" style="border-left: 5px solid #ffc107; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-wrench" style="font-size: 2.5rem; color: #ffc107;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Fichas Abiertas</h5>
                        <h1 class="display-4 fw-bold text-warning">{{ stats.fichas_abiertas }}</h1>
                        <p class="text-muted small mb-0">Reparaciones en curso sin cerrar</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('envios_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.envios_pendientes > 0 %}border-info{% endif %}" style="border-left: 5px solid #17a2b8; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-truck" style="font-size: 2.5rem; color: #17a2b8;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Envíos Pendientes</h5>
                        <h1 class="display-4 fw-bold text-info">{{ stats.envios_pendientes }}</h1>
                        <p class="text-muted small mb-0">Transferencias entre ubicaciones</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('stock_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.stock_bajo_total > 0 %}border-danger{% endif %}" style="border-left: 5px solid #dc3545; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-exclamation-triangle" style="font-size: 2.5rem; color: #dc3545;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Stock Crítico ≤2</h5>
                        <h1 class="display-4 fw-bold text-danger">{{ stats.stock_bajo_total }}</h1>
                        <p class="text-muted small mb-0">Repuestos en todas las ubicaciones</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Auto-refresh cada 45 segundos para sincronización en tiempo real
setTimeout(function() {
    location.reload();
}, 45000);

// Mostrar última actualización
const ahora = new Date();
const hora = ahora.toLocaleTimeString('es-AR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
console.log('Dashboard actualizado a las ' + hora);
</script>
{% endblock %}

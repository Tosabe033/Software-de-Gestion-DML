{% extends "base.html" %}

{% block title %}Dashboard - DML ST{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Inicio</h1>

    {% set role = user.role %}

    {% if role == 'RAYPAC' %}
    <div class="row mb-4">
        <div class="col-md-3">
            <a href="{{ url_for('raypac_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-box-seam"></i> Equipos registrados</h5>
                        <h2 class="text-primary">{{ stats.equipos_registrados }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('raypac_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-truck"></i> Sin remito</h5>
                        <h2 class="text-warning">{{ stats.equipos_sin_remito }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('envios_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-send"></i> Envíos pendientes</h5>
                        <h2 class="text-info">{{ stats.envios_pendientes }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('stock_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-exclamation-triangle"></i> Stock RAYPAC ≤2</h5>
                        <h2 class="text-danger">{{ stats.stock_bajo }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Acciones Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="{{ url_for('raypac_new') }}" class="list-group-item list-group-item-action"><i class="bi bi-plus-circle"></i> Nuevo Ingreso RAYPAC</a>
                        <a href="{{ url_for('raypac_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-box-seam"></i> Ver ingresos RAYPAC</a>
                        <a href="{{ url_for('envios_new') }}" class="list-group-item list-group-item-action"><i class="bi bi-truck"></i> Enviar repuestos a DML</a>
                        <a href="{{ url_for('stock_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-bag-check"></i> Stock RAYPAC</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex align-items-center">
                    <h5 class="mb-0">Notificaciones</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-truck"></i> Ingresos sin remito</span>
                            <span class="badge bg-warning text-dark">{{ stats.equipos_sin_remito }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-send"></i> Envíos pendientes a DML</span>
                            <span class="badge bg-info text-dark">{{ stats.envios_pendientes }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-exclamation-triangle"></i> Repuestos en alerta (≤2)</span>
                            <span class="badge bg-danger">{{ stats.stock_bajo }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% elif role == 'DML_REPUESTOS' %}
    <div class="row mb-4">
        <div class="col-md-3">
            <a href="{{ url_for('stock_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-exclamation-triangle"></i> Stock DML ≤2</h5>
                        <h2 class="text-danger">{{ stats.stock_bajo }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('envios_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-truck"></i> Envíos pendientes</h5>
                        <h2 class="text-warning">{{ stats.envios_pendientes }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-clock-history"></i> Espera repuestos</h5>
                        <h2 class="text-info">{{ stats.fichas_espera_repuestos }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('tickets_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-ticket-detailed"></i> Tickets activos</h5>
                        <h2 class="text-primary">{{ stats.tickets_activos }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Acciones Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="{{ url_for('stock_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-bag-check"></i> Stock DML</a>
                        <a href="{{ url_for('stock_new') }}" class="list-group-item list-group-item-action"><i class="bi bi-plus-circle"></i> Ingresar repuesto</a>
                        <a href="{{ url_for('estadisticas') }}" class="list-group-item list-group-item-action"><i class="bi bi-graph-up"></i> Estadísticas de repuestos</a>
                        <a href="{{ url_for('envios_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-truck"></i> Recepcionar envíos</a>
                        <a href="{{ url_for('dml_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-wrench"></i> Fichas ST</a>
                        <a href="{{ url_for('tickets_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-ticket-detailed"></i> Tickets</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex align-items-center">
                    <h5 class="mb-0">Notificaciones</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-truck"></i> Envíos pendientes a recibir</span>
                            <span class="badge bg-warning text-dark">{{ stats.envios_pendientes }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-exclamation-triangle"></i> Repuestos DML en alerta (≤2)</span>
                            <span class="badge bg-danger">{{ stats.stock_bajo }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-clock-history"></i> Fichas esperando repuestos</span>
                            <span class="badge bg-info text-dark">{{ stats.fichas_espera_repuestos }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% elif role == 'DML_ST' %}
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i> <strong>Dashboard del Técnico:</strong> Vista general del flujo de reparaciones. Haz clic en cada tarjeta para ver el detalle.
    </div>
    
    <h4 class="mb-3"><i class="bi bi-gear-fill"></i> Flujo de Reparación</h4>
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #17a2b8; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-search" style="font-size: 2.5rem; color: #17a2b8;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Revisión Inicial</h5>
                        <h1 class="display-4 fw-bold text-info">{{ stats.fichas_revision_inicial }}</h1>
                        <p class="text-muted small mb-0">Equipos recién llegados pendientes de diagnóstico</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #007bff; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-tools" style="font-size: 2.5rem; color: #007bff;"></i>
                        </div>
                        <h5 class="card-title fw-bold">En Reparación</h5>
                        <h1 class="display-4 fw-bold text-primary">{{ stats.fichas_en_reparacion }}</h1>
                        <p class="text-muted small mb-0">Máquinas en proceso de reparación activa</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #ffc107; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-clock-history" style="font-size: 2.5rem; color: #ffc107;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Esperando Repuestos</h5>
                        <h1 class="display-4 fw-bold text-warning">{{ stats.fichas_espera_repuestos }}</h1>
                        <p class="text-muted small mb-0">Pausadas hasta recibir componentes</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="border-left: 5px solid #28a745; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-check-circle-fill" style="font-size: 2.5rem; color: #28a745;"></i>
                        </div>
                        <h5 class="card-title fw-bold">Listas para Retirar</h5>
                        <h1 class="display-4 fw-bold text-success">{{ stats.fichas_listas }}</h1>
                        <p class="text-muted small mb-0">Reparadas y listas para entrega</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>
    
    <h4 class="mb-3 mt-4"><i class="bi bi-bell-fill"></i> Alertas y Pendientes</h4>
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <a href="{{ url_for('raypac_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.equipos_raypac_pendientes > 0 %}border-warning{% endif %}" style="transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-box-seam" style="font-size: 2rem; color: #ff9800;"></i>
                            </div>
                            <h2 class="display-6 fw-bold text-warning mb-0">{{ stats.equipos_raypac_pendientes }}</h2>
                        </div>
                        <h6 class="fw-bold">Equipos RAYPAC Pendientes</h6>
                        <p class="text-muted small mb-0"><i class="bi bi-arrow-right-circle"></i> Envíos de casa matriz para recepcionar y crear fichas</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative {% if stats.repuestos_disponibles > 0 %}border-success{% endif %}" style="transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-bag-check-fill" style="font-size: 2rem; color: #28a745;"></i>
                            </div>
                            <h2 class="display-6 fw-bold text-success mb-0">{{ stats.repuestos_disponibles }}</h2>
                        </div>
                        <h6 class="fw-bold">Repuestos Disponibles</h6>
                        <p class="text-muted small mb-0"><i class="bi bi-arrow-right-circle"></i> Componentes que estaban agotados ahora en stock</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('tickets_list') }}" class="text-decoration-none">
                <div class="card shadow-sm h-100 position-relative" style="transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="bi bi-ticket-perforated-fill" style="font-size: 2rem; color: #6c757d;"></i>
                            </div>
                            <h2 class="display-6 fw-bold text-dark mb-0">{{ stats.tickets_activos }}</h2>
                        </div>
                        <h6 class="fw-bold">Tickets Activos</h6>
                        <p class="text-muted small mb-0"><i class="bi bi-arrow-right-circle"></i> Tickets de seguimiento para clientes</p>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>

    {% else %} {# ADMIN #}
    <div class="row mb-4">
        <div class="col-md-3">
            <a href="{{ url_for('raypac_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-box-seam"></i> Equipos RAYPAC</h5>
                        <h2 class="text-primary">{{ stats.equipos_raypac }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('dml_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-wrench"></i> Fichas abiertas</h5>
                        <h2 class="text-warning">{{ stats.fichas_abiertas }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('envios_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-truck"></i> Envíos pendientes</h5>
                        <h2 class="text-info">{{ stats.envios_pendientes }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="{{ url_for('stock_list') }}" class="text-decoration-none text-dark">
                <div class="card text-center shadow-sm position-relative">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-exclamation-triangle"></i> Stock ≤2 (todas ubic.)</h5>
                        <h2 class="text-danger">{{ stats.stock_bajo_total }}</h2>
                        <span class="stretched-link"></span>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Acciones Rápidas</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="{{ url_for('raypac_new') }}" class="list-group-item list-group-item-action"><i class="bi bi-plus-circle"></i> Nuevo ingreso RAYPAC</a>
                        <a href="{{ url_for('raypac_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-box-seam"></i> Ver ingresos RAYPAC</a>
                        <a href="{{ url_for('dml_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-wrench"></i> Fichas ST</a>
                        <a href="{{ url_for('envios_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-truck"></i> Envíos</a>
                        <a href="{{ url_for('stock_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-bag-check"></i> Stock</a>
                        <a href="{{ url_for('usuarios_list') }}" class="list-group-item list-group-item-action"><i class="bi bi-people"></i> Usuarios</a>
                        <a href="{{ url_for('estadisticas') }}" class="list-group-item list-group-item-action"><i class="bi bi-bar-chart"></i> Estadísticas</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex align-items-center">
                    <h5 class="mb-0">Notificaciones</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-box-seam"></i> Equipos RAYPAC cargados</span>
                            <span class="badge bg-primary">{{ stats.equipos_raypac }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-wrench"></i> Fichas abiertas</span>
                            <span class="badge bg-warning text-dark">{{ stats.fichas_abiertas }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-truck"></i> Envíos pendientes</span>
                            <span class="badge bg-info text-dark">{{ stats.envios_pendientes }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-exclamation-triangle"></i> Stock ≤2 (todas ubic.)</span>
                            <span class="badge bg-danger">{{ stats.stock_bajo_total }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Auto-refresh cada 45 segundos para sincronización en tiempo real
setTimeout(function() {
    location.reload();
}, 45000);

// Mostrar última actualización
const ahora = new Date();
const hora = ahora.toLocaleTimeString('es-AR', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
console.log('Dashboard actualizado a las ' + hora);
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}RAYPAC - Ingreso{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h2 class="mb-4">{% if entry %}Editar{% else %}Nuevo Ingreso{% endif %} RAYPAC</h2>

            <form method="POST" class="needs-validation">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="fecha_recepcion" class="form-label">Fecha Recepción *</label>
                                <input type="date" class="form-control" id="fecha_recepcion" name="fecha_recepcion" 
                                       value="{{ entry.fecha_recepcion if entry else '' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_solicitud" class="form-label">Tipo Solicitud *</label>
                                <select class="form-control" id="tipo_solicitud" name="tipo_solicitud" required>
                                    <option value="">Selecciona</option>
                                    <option value="REPARACIÓN" {% if entry and entry.tipo_solicitud == 'REPARACIÓN' %}selected{% endif %}>REPARACIÓN</option>
                                    <option value="PRESUPUESTO" {% if entry and entry.tipo_solicitud == 'PRESUPUESTO' %}selected{% endif %}>PRESUPUESTO</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="cliente" class="form-label">Cliente *</label>
                                <input type="text" class="form-control" id="cliente" name="cliente" 
                                       value="{{ entry.cliente if entry else '' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="numero_serie" class="form-label">N° Serie *</label>
                                <input type="text" class="form-control" id="numero_serie" name="numero_serie" 
                                       value="{{ entry.numero_serie if entry else '' }}" required>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="contacto_cliente" class="form-label">Contacto del Cliente</label>
                                <input type="text" class="form-control" id="contacto_cliente" name="contacto_cliente" 
                                       value="{{ entry.contacto_cliente if entry else '' }}" 
                                       placeholder="Nombre del contacto">
                                <small class="text-muted">Visible solo para RAYPAC y ADMIN</small>
                            </div>
                            <div class="col-md-6">
                                <label for="email_cliente" class="form-label">Email del Cliente</label>
                                <input type="email" class="form-control" id="email_cliente" name="email_cliente" 
                                       value="{{ entry.email_cliente if entry else '' }}"
                                       placeholder="correo@empresa.com">
                                <small class="text-muted">Visible solo para RAYPAC y ADMIN</small>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modelo_maquina" class="form-label">Modelo Máquina *</label>
                                <select class="form-control" id="modelo_maquina" name="modelo_maquina" required>
                                    <option value="">Selecciona</option>
                                    <option value="ITA10" {% if entry and entry.modelo_maquina == 'ITA10' %}selected{% endif %}>ITA10</option>
                                    <option value="ITA11" {% if entry and entry.modelo_maquina == 'ITA11' %}selected{% endif %}>ITA11</option>
                                    <option value="ITA12" {% if entry and entry.modelo_maquina == 'ITA12' %}selected{% endif %}>ITA12</option>
                                    <option value="ITA20" {% if entry and entry.modelo_maquina == 'ITA20' %}selected{% endif %}>ITA20</option>
                                    <option value="ITA21" {% if entry and entry.modelo_maquina == 'ITA21' %}selected{% endif %}>ITA21</option>
                                    <option value="ITA24" {% if entry and entry.modelo_maquina == 'ITA24' %}selected{% endif %}>ITA24</option>
                                    <option value="ITA25" {% if entry and entry.modelo_maquina == 'ITA25' %}selected{% endif %}>ITA25</option>
                                    <option value="CT20" {% if entry and entry.modelo_maquina == 'CT20' %}selected{% endif %}>CT20</option>
                                    <option value="CT25" {% if entry and entry.modelo_maquina == 'CT25' %}selected{% endif %}>CT25</option>
                                    <option value="CT40" {% if entry and entry.modelo_maquina == 'CT40' %}selected{% endif %}>CT40</option>
                                    <option value="CTT20" {% if entry and entry.modelo_maquina == 'CTT20' %}selected{% endif %}>CTT20</option>
                                    <option value="CTT25" {% if entry and entry.modelo_maquina == 'CTT25' %}selected{% endif %}>CTT25</option>
                                    <option value="CTT40" {% if entry and entry.modelo_maquina == 'CTT40' %}selected{% endif %}>CTT40</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="tipo_maquina" class="form-label">Tipo Máquina *</label>
                                <select class="form-control" id="tipo_maquina" name="tipo_maquina" required>
                                    <option value="">Selecciona</option>
                                    <option value="A BATERIA" {% if entry and entry.tipo_maquina == 'A BATERIA' %}selected{% endif %}>A BATERIA</option>
                                    <option value="MANUAL" {% if entry and entry.tipo_maquina == 'MANUAL' %}selected{% endif %}>MANUAL</option>
                                    <option value="NEUMÁTICA" {% if entry and entry.tipo_maquina == 'NEUMÁTICA' %}selected{% endif %}>NEUMÁTICA</option>
                                    <option value="OTRO" {% if entry and entry.tipo_maquina == 'OTRO' %}selected{% endif %}>OTRO</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="numero_bateria" class="form-label">N° Batería</label>
                                <input type="text" class="form-control" id="numero_bateria" name="numero_bateria" 
                                       value="{{ entry.numero_bateria if entry else 'NO APLICA' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="numero_cargador" class="form-label">N° Cargador</label>
                                <input type="text" class="form-control" id="numero_cargador" name="numero_cargador" 
                                       value="{{ entry.numero_cargador if entry else 'NO APLICA' }}">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="diagnostico_ingreso" class="form-label">Diagnóstico Ingreso</label>
                                <textarea class="form-control" id="diagnostico_ingreso" name="diagnostico_ingreso" rows="3">{{ entry.diagnostico_ingreso if entry else '' }}</textarea>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="comercial" class="form-label">Comercial Responsable *</label>
                                <select class="form-control" id="comercial" name="comercial" required>
                                    <option value="">Selecciona</option>
                                    <option value="Ezequiel Pacheco" data-email="ezequiel.pacheco@raypac.net" {% if entry and entry.comercial == 'Ezequiel Pacheco' %}selected{% endif %}>Ezequiel Pacheco</option>
                                    <option value="Leonardo Gastager" data-email="leonardo.gastager@raypac.net" {% if entry and entry.comercial == 'Leonardo Gastager' %}selected{% endif %}>Leonardo Gastager</option>
                                    <option value="Luciana Gregorio" data-email="luciana.gregorio@raypac.net" {% if entry and entry.comercial == 'Luciana Gregorio' %}selected{% endif %}>Luciana Gregorio</option>
                                    <option value="Luciana Paradiso" data-email="luciana.paradiso@raypac.net" {% if entry and entry.comercial == 'Luciana Paradiso' %}selected{% endif %}>Luciana Paradiso</option>
                                    <option value="Daniela Sofio" data-email="daniela.sofio@raypac.net" {% if entry and entry.comercial == 'Daniela Sofio' %}selected{% endif %}>Daniela Sofio</option>
                                    <option value="Hernán Rivero" data-email="hernan.rivero@raypac.net" {% if entry and entry.comercial == 'Hernán Rivero' %}selected{% endif %}>Hernán Rivero</option>
                                    <option value="Matias Chaubell" data-email="matias.chaubell@raypac.net" {% if entry and entry.comercial == 'Matias Chaubell' %}selected{% endif %}>Matias Chaubell</option>
                                    <option value="Paola Isanelli" data-email="paola.isabelli@raypac.net" {% if entry and entry.comercial == 'Paola Isanelli' %}selected{% endif %}>Paola Isanelli</option>
                                    <option value="Romina Gamarra" data-email="romina.gamarra@raypac.net" {% if entry and entry.comercial == 'Romina Gamarra' %}selected{% endif %}>Romina Gamarra</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="mail_comercial" class="form-label">Mail Comercial *</label>
                                <input type="email" class="form-control" id="mail_comercial" name="mail_comercial" 
                                       value="{{ entry.mail_comercial if entry else '' }}" required readonly style="background-color: #e9ecef;">
                            </div>
                        </div>

                        {% if entry and entry.is_frozen %}
                        <div class="alert alert-warning">
                            <strong style="color: black;">Codigo de desbloqueo requerido.</strong> Ingresa el codigo para editar.
                            <div class="mt-2">
                                <input type="text" class="form-control" placeholder="Codigo de desbloqueo (ej: ADMIN2024)" name="unfreeze_code" style="color: black; font-weight: bold;">
                            </div>
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('raypac_list') }}" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-primary">
                                {% if entry %}Actualizar{% else %}Crear{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Autocompletar email cuando se selecciona un comercial
    document.getElementById('comercial').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const email = selectedOption.getAttribute('data-email');
        const emailInput = document.getElementById('mail_comercial');
        
        if (email) {
            emailInput.value = email;
        } else {
            emailInput.value = '';
        }
    });
    
    // Al cargar la página, si ya hay un comercial seleccionado, completar el email
    window.addEventListener('DOMContentLoaded', function() {
        const comercialSelect = document.getElementById('comercial');
        const selectedOption = comercialSelect.options[comercialSelect.selectedIndex];
        const email = selectedOption.getAttribute('data-email');
        const emailInput = document.getElementById('mail_comercial');
        
        if (email && !emailInput.value) {
            emailInput.value = email;
        }
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1>üé´ Tickets de Seguimiento</h1>
    
    <!-- B√öSQUEDA Y FILTROS -->
    <div class="card mb-4 p-4">
        <form method="GET" class="row g-3">
            <div class="col-md-5">
                <label for="buscar" class="form-label">Buscar por Ticket o Serie:</label>
                <input type="text" class="form-control" name="buscar" id="buscar" 
                       value="{{ buscar }}" placeholder="Ej: TK-2025-SERIE-00001">
            </div>
            <div class="col-md-3">
                <label for="estado" class="form-label">Estado:</label>
                <select class="form-control" name="estado" id="estado">
                    <option value="">Todos</option>
                    <option value="ACTIVO" {% if estado == 'ACTIVO' %}selected{% endif %}>ACTIVO</option>
                    <option value="CERRADO" {% if estado == 'CERRADO' %}selected{% endif %}>CERRADO</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Mostrar cerrados:</label>
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" name="cerrados" value="1" 
                           id="cerrados" {% if mostrar_cerrados %}checked{% endif %}>
                    <label class="form-check-label" for="cerrados">S√≠</label>
                </div>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">üîç Buscar</button>
            </div>
        </form>
    </div>

    <!-- TABLA DE TICKETS -->
    {% if tickets %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Ticket</th>
                    <th>N√∫mero de Serie</th>
                    <th>Ficha</th>
                    <th>Estado Reparaci√≥n</th>
                    <th>Creaci√≥n</th>
                    <th>Estado</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                <tr>
                    <td><strong>{{ ticket.numero_ticket }}</strong></td>
                    <td>{{ ticket.numero_serie }}</td>
                    <td>
                        <a href="{{ url_for('dml_view', id=ticket.ficha_id) }}">
                            #{{ ticket.numero_ficha }}
                        </a>
                    </td>
                    <td>
                        <span class="badge bg-info">{{ ticket.estado_reparacion }}</span>
                    </td>
                    <td>{{ ticket.fecha_creacion[:10] }}</td>
                    <td>
                        {% if ticket.estado == 'ACTIVO' %}
                        <span class="badge bg-success">ACTIVO</span>
                        {% else %}
                        <span class="badge bg-secondary">CERRADO</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('ticket_view', numero_ticket=ticket.numero_ticket) }}" 
                           class="btn btn-sm btn-info">
                            üëÅÔ∏è Ver
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        <p>No hay tickets que coincidan con los criterios de b√∫squeda.</p>
    </div>
    {% endif %}

    <div class="mt-4">
        <a href="{{ url_for('dml_list') }}" class="btn btn-secondary">‚¨ÖÔ∏è Volver</a>
    </div>
    
    <div class="text-muted text-center mt-3 small">
        <i class="bi bi-arrow-clockwise"></i> Actualizaci√≥n autom√°tica cada 45 segundos
    </div>
</div>

<script>
// Auto-refresh cada 45 segundos
setTimeout(function() {
    location.reload();
}, 45000);
</script>
{% endblock %}
